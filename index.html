<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dynasty 8 ‚Äì Comptabilit√©</title>

<style>
body {
  background: linear-gradient(135deg, #0b0b0b, #1f1f1f);
  color: #eee;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  padding: 30px;
}

.container {
  max-width: 1000px;
  margin: auto;
  background: #121212;
  border-radius: 15px;
  box-shadow: 0 0 40px #c62828aa;
  padding: 25px 30px;
}

h1 {
  text-align: center;
  color: #c62828;
  margin-bottom: 25px;
  font-weight: 900;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: #222;
  border-radius: 8px;
  overflow: hidden;
}

thead {
  background: #c62828;
  color: white;
}

th, td {
  padding: 10px;
  border-bottom: 1px solid #444;
  text-align: center;
}

input, select {
  width: 95%;
  padding: 6px;
  border-radius: 6px;
  border: none;
  background: #2e2e2e;
  color: white;
}

input[type=file] {
  background: none;
}

button {
  background: #c62828;
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  padding: 12px;
  font-size: 16px;
  font-weight: bold;
  margin-top: 15px;
  width: 100%;
}

button:hover {
  background: #a22121;
}

.btn-delete {
  background: darkred;
  padding: 6px 12px;
  font-size: 14px;
}

.preview-img {
  max-width: 80px;
  max-height: 50px;
  margin-top: 5px;
  border-radius: 6px;
  border: 1px solid #c62828;
}

#totals {
  margin-top: 15px;
  font-size: 18px;
  font-weight: bold;
}
</style>
</head>

<body>

<div class="container">
<h1>üè¢ Dynasty 8 ‚Äì Registre des ventes</h1>

<table>
<thead>
<tr>
  <th>Nom</th>
  <th>Poste</th>
  <th>Type</th>
  <th>Montant ($)</th>
  <th>Jours</th>
  <th>Preuve</th>
  <th>Supprimer</th>
</tr>
</thead>
<tbody id="table-body"></tbody>
</table>

<button onclick="ajouterLigne()">+ Ajouter une vente</button>
<button onclick="envoyerTout()">üì§ Envoyer √† la compta Discord</button>

<p id="totals">Total des ventes : 0 $</p>
</div>

<script>
const WEBHOOK_URL = "https://discord.com/api/webhooks/1461476549688688680/XOhZqQke8f4_x07k-OWYPGRndjkRTGV2jyJCGpnoLE8gMcGzbIMQZQRSEtbt4_hZUZf_";

const POSTES = [
  "PDG",
  "Directeur",
  "Agent Senior",
  "Agent Immobilier",
  "Stagiaire"
];

function ajouterLigne() {
  const tbody = document.getElementById("table-body");
  const tr = document.createElement("tr");

  tr.innerHTML = `
    <td><input type="text" placeholder="Nom RP" required></td>

    <td>
      <select>
        ${POSTES.map(p => `<option>${p}</option>`).join("")}
      </select>
    </td>

    <td>
      <select class="type" onchange="toggleLocation(this)">
        <option value="achat">Achat</option>
        <option value="location">Location</option>
      </select>
    </td>

    <td>
      <input type="number" class="montant" min="0" value="0" oninput="calculerTotal()">
    </td>

    <td>
      <input type="number" class="jours" min="1" value="1" style="display:none" oninput="calculerTotal()">
    </td>

    <td>
      <input type="file" accept="image/*" onchange="previewImage(event)">
      <br>
      <img class="preview-img" style="display:none">
    </td>

    <td>
      <button class="btn-delete" onclick="supprimerLigne(this)">X</button>
    </td>
  `;

  tbody.appendChild(tr);
  calculerTotal();
}

function toggleLocation(select) {
  const tr = select.closest("tr");
  const jours = tr.querySelector(".jours");

  if (select.value === "location") {
    jours.style.display = "block";
  } else {
    jours.style.display = "none";
    jours.value = 1;
  }
  calculerTotal();
}

function supprimerLigne(btn) {
  btn.closest("tr").remove();
  calculerTotal();
}

function previewImage(e) {
  const img = e.target.nextElementSibling;
  img.src = URL.createObjectURL(e.target.files[0]);
  img.style.display = "block";
}

function calculerTotal() {
  let total = 0;
  document.querySelectorAll("#table-body tr").forEach(tr => {
    const type = tr.querySelector(".type").value;
    const montant = parseFloat(tr.querySelector(".montant").value) || 0;
    const jours = parseInt(tr.querySelector(".jours").value) || 1;

    total += (type === "achat") ? montant : montant * jours;
  });

  document.getElementById("totals").innerText =
    "Total des ventes : " + total.toLocaleString() + " $";
}

async function envoyerTout() {
  const rows = document.querySelectorAll("#table-body tr");
  if (!rows.length) return alert("Aucune vente");

  const formData = new FormData();
  let embeds = [];

  rows.forEach((tr, i) => {
    const nom = tr.cells[0].querySelector("input").value;
    const poste = tr.cells[1].querySelector("select").value;
    const type = tr.querySelector(".type").value;
    const montant = tr.querySelector(".montant").value;
    const jours = tr.querySelector(".jours").value;
    const file = tr.querySelector("input[type=file]").files[0];

    const filename = `preuve_${i}.png`;
    formData.append(`files[${i}]`, file, filename);

    embeds.push({
      title: `üìä Vente #${i + 1}`,
      color: 13369344,
      fields: [
        { name: "üë§ Nom", value: nom, inline: true },
        { name: "üè∑Ô∏è Poste", value: poste, inline: true },
        { name: "üì¶ Type", value: type === "achat" ? "Achat" : `Location (${jours} jours)`, inline: true },
        { name: "üí∞ Total", value: type === "achat"
            ? `${montant} $`
            : `${montant * jours} $`, inline: true }
      ],
      image: { url: `attachment://${filename}` }
    });
  });

  formData.append("payload_json", JSON.stringify({ embeds }));

  await fetch(WEBHOOK_URL, { method: "POST", body: formData });
  alert("‚úÖ Envoy√© !");
  document.getElementById("table-body").innerHTML = "";
  ajouterLigne();
}

window.onload = ajouterLigne;
</script>

</body>
</html>
