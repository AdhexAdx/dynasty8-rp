<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dynasty 8 ‚Äì Comptabilit√©</title>

<style>
body {
  background:#111;
  color:#eee;
  font-family:Segoe UI, sans-serif;
  padding:30px;
}

.container {
  max-width:1100px;
  margin:auto;
  background:#1a1a1a;
  padding:25px;
  border-radius:15px;
  box-shadow:0 0 30px #c62828;
}

h1 {
  text-align:center;
  color:#c62828;
}

table {
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}

thead {
  background:#c62828;
}

th, td {
  padding:10px;
  text-align:center;
  border-bottom:1px solid #333;
}

input, select {
  width:95%;
  padding:6px;
  background:#2a2a2a;
  color:white;
  border:none;
  border-radius:6px;
}

input[type=checkbox] {
  width:auto;
  transform:scale(1.3);
}

input[type=file] {
  background:none;
}

button {
  width:100%;
  padding:12px;
  margin-top:10px;
  background:#c62828;
  color:white;
  border:none;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer;
}

button:hover {
  background:#a22121;
}

.btn-delete {
  background:darkred;
  padding:6px 12px;
}

.preview {
  max-width:80px;
  display:none;
  margin-top:5px;
  border-radius:6px;
}

#total {
  margin-top:15px;
  font-size:18px;
}
</style>
</head>

<body>

<div class="container">
<h1>üè¢ Dynasty 8 ‚Äì Registre des ventes</h1>

<table>
<thead>
<tr>
  <th>Nom</th>
  <th>Poste</th>
  <th>Location ?</th>
  <th>Montant ($)</th>
  <th>Jours</th>
  <th>Preuve</th>
  <th>Suppr.</th>
</tr>
</thead>
<tbody id="body"></tbody>
</table>

<button onclick="addRow()">‚ûï Ajouter une vente</button>
<button onclick="sendDiscord()">üì§ Envoyer √† Discord</button>
<button onclick="exportCSV()">üìä Export Excel</button>

<div id="total">Total : 0 $</div>
</div>

<script>
const WEBHOOK_URL = "MET_TON_WEBHOOK_ICI";

const POSTES = ["PDG","Directeur","Agent Senior","Agent Immobilier","Stagiaire"];

function addRow() {
  const tr = document.createElement("tr");

  tr.innerHTML = `
    <td><input placeholder="Nom RP"></td>

    <td>
      <select>
        ${POSTES.map(p => `<option>${p}</option>`).join("")}
      </select>
    </td>

    <td>
      <input type="checkbox" onchange="toggleLocation(this)">
    </td>

    <td>
      <input type="number" min="0" value="0" oninput="calcTotal()">
    </td>

    <td>
      <input type="number" min="1" value="1" style="display:none" oninput="calcTotal()">
    </td>

    <td>
      <input type="file" accept="image/*" onchange="previewImg(this)">
      <img class="preview">
    </td>

    <td>
      <button class="btn-delete" onclick="this.closest('tr').remove(); calcTotal()">X</button>
    </td>
  `;

  document.getElementById("body").appendChild(tr);
}

function toggleLocation(cb) {
  const tr = cb.closest("tr");
  const jours = tr.cells[4].querySelector("input");

  if (cb.checked) {
    jours.style.display = "block";
  } else {
    jours.style.display = "none";
    jours.value = 1;
  }
  calcTotal();
}

function previewImg(input) {
  const img = input.nextElementSibling;
  if (input.files[0]) {
    img.src = URL.createObjectURL(input.files[0]);
    img.style.display = "block";
  } else {
    img.style.display = "none";
  }
}

function calcTotal() {
  let total = 0;
  document.querySelectorAll("#body tr").forEach(tr => {
    const montant = parseFloat(tr.cells[3].querySelector("input").value) || 0;
    const isLoc = tr.cells[2].querySelector("input").checked;
    const jours = parseInt(tr.cells[4].querySelector("input").value) || 1;
    total += isLoc ? montant * jours : montant;
  });
  document.getElementById("total").innerText =
    "Total : " + total.toLocaleString() + " $";
}

/* ========= EXPORT CSV ========= */
function exportCSV() {
  let csv = "Nom;Poste;Type;Montant;Jours;Total\n";

  document.querySelectorAll("#body tr").forEach(tr => {
    const nom = tr.cells[0].querySelector("input").value;
    const poste = tr.cells[1].querySelector("select").value;
    const isLoc = tr.cells[2].querySelector("input").checked;
    const montant = tr.cells[3].querySelector("input").value;
    const jours = tr.cells[4].querySelector("input").value || 1;
    const total = isLoc ? montant * jours : montant;

    csv += `${nom};${poste};${isLoc?"Location":"Achat"};${montant};${jours};${total}\n`;
  });

  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "dynasty8_ventes.csv";
  a.click();
}

/* ========= DISCORD ========= */
async function sendDiscord() {
  const rows = document.querySelectorAll("#body tr");
  if (rows.length === 0) return alert("Aucune vente");

  const formData = new FormData();
  const embeds = [];

  rows.forEach((tr, i) => {
    const nom = tr.cells[0].querySelector("input").value;
    const poste = tr.cells[1].querySelector("select").value;
    const isLoc = tr.cells[2].querySelector("input").checked;
    const montant = tr.cells[3].querySelector("input").value;
    const jours = tr.cells[4].querySelector("input").value;
    const file = tr.cells[5].querySelector("input").files[0];

    if (!nom || !file) {
      alert("Nom ou image manquante");
      throw new Error("Champs manquants");
    }

    const filename = `preuve_${i}.png`;
    formData.append(`files[${i}]`, file, filename);

    embeds.push({
      title: `Vente #${i+1}`,
      color: 13369344,
      fields: [
        { name:"Agent", value:nom, inline:true },
        { name:"Poste", value:poste, inline:true },
        { name:"Type", value:isLoc?`Location (${jours} jours)`:"Achat", inline:true },
        { name:"Total", value:isLoc?`${montant*jours} $`:`${montant} $`, inline:true }
      ],
      image:{ url:`attachment://${filename}` }
    });
  });

  formData.append("payload_json", JSON.stringify({embeds}));

  await fetch(WEBHOOK_URL, { method:"POST", body:formData });

  alert("‚úÖ Envoy√© sur Discord");
  document.getElementById("body").innerHTML = "";
  calcTotal();
}

addRow();
</script>

</body>
</html>
